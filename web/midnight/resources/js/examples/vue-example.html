<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midnight Voting DApp - Vue 3 Example</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div id="app" class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Midnight Voting DApp</h1>
            <p class="text-gray-600 mt-2">Cast your vote securely on the Midnight blockchain</p>
        </header>

        <!-- Wallet Connection -->
        <div class="mb-8">
            <wallet-connect
                :show-network="true"
                :show-disconnect-button="true"
                @connected="handleWalletConnected"
                @disconnected="handleWalletDisconnected"
                @error="handleWalletError"
            ></wallet-connect>
        </div>

        <!-- Voting Form (shown when wallet is connected) -->
        <div v-if="walletConnected" class="mb-8">
            <vote-form
                :contract-address="contractAddress"
                :candidates="candidates"
                :loading="loadingElection"
                @submit="handleVoteSubmit"
                @success="handleVoteSuccess"
                @error="handleVoteError"
            ></vote-form>
        </div>

        <!-- Transaction Status (shown when vote is submitted) -->
        <div v-if="txHash">
            <transaction-status
                :transaction-hash="txHash"
                :explorer-base-url="explorerUrl"
                :auto-poll="true"
                @confirmed="handleTxConfirmed"
                @failed="handleTxFailed"
            ></transaction-status>
        </div>
    </div>

    <script type="module">
        import { createApp } from 'vue';
        import { WalletConnect, VoteForm, TransactionStatus } from './components';

        const app = createApp({
            components: {
                WalletConnect,
                VoteForm,
                TransactionStatus,
            },

            data() {
                return {
                    walletConnected: false,
                    walletAddress: null,
                    contractAddress: '0x1234567890abcdef1234567890abcdef12345678',
                    candidates: [
                        {
                            id: 1,
                            name: 'Alice Johnson',
                            description: 'Experienced blockchain developer with focus on privacy'
                        },
                        {
                            id: 2,
                            name: 'Bob Smith',
                            description: 'Security researcher specializing in zero-knowledge proofs'
                        },
                        {
                            id: 3,
                            name: 'Carol Williams',
                            description: 'Community organizer promoting decentralized governance'
                        }
                    ],
                    txHash: null,
                    explorerUrl: 'https://explorer.midnight.network',
                    loadingElection: false,
                };
            },

            methods: {
                handleWalletConnected(address) {
                    console.log('Wallet connected:', address);
                    this.walletConnected = true;
                    this.walletAddress = address;

                    // Load election data from backend
                    this.loadElectionData();
                },

                handleWalletDisconnected() {
                    console.log('Wallet disconnected');
                    this.walletConnected = false;
                    this.walletAddress = null;
                    this.txHash = null;
                },

                handleWalletError(error) {
                    console.error('Wallet error:', error);
                    alert('Wallet error: ' + error);
                },

                async loadElectionData() {
                    this.loadingElection = true;

                    try {
                        const response = await fetch('/api/election');
                        const data = await response.json();

                        this.contractAddress = data.midnight_contract_address;
                        this.candidates = data.candidates;
                    } catch (error) {
                        console.error('Failed to load election data:', error);
                    } finally {
                        this.loadingElection = false;
                    }
                },

                handleVoteSubmit(payload) {
                    console.log('Vote submitted:', payload);
                },

                async handleVoteSuccess(txHash) {
                    console.log('Vote transaction hash:', txHash);
                    this.txHash = txHash;

                    // Record vote on backend
                    try {
                        await fetch('/api/votes', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.content || '',
                            },
                            body: JSON.stringify({
                                txHash: txHash,
                                walletAddress: this.walletAddress,
                            }),
                        });
                    } catch (error) {
                        console.error('Failed to record vote on backend:', error);
                    }
                },

                handleVoteError(error) {
                    console.error('Vote error:', error);
                    alert('Vote error: ' + error);
                },

                handleTxConfirmed(txInfo) {
                    console.log('Transaction confirmed:', txInfo);
                    alert('Your vote has been confirmed on the blockchain!');
                },

                handleTxFailed(txInfo) {
                    console.error('Transaction failed:', txInfo);
                    alert('Transaction failed. Please try again.');
                },
            },
        });

        app.mount('#app');
    </script>
</body>
</html>
